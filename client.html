
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Therapeutic Companion - Weekly Tracking System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f7fa;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 2rem 0;
            overflow: hidden;
        }

        .tab {
            flex: 1;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            background: white;
            border: none;
            font-size: 1rem;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab:hover {
            background: #f0f4f8;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #764ba2;
        }

        .content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .hidden {
            display: none;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #4a5568;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 4px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        button {
            background: #667eea;
            color: white;
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #5a67d8;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .success {
            background: #48bb78;
            color: white;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .error {
            background: #f56565;
            color: white;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .info {
            background: #4299e1;
            color: white;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .rating-group {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .rating-option {
            flex: 1;
            text-align: center;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .rating-option:hover {
            border-color: #667eea;
            background: #f7fafc;
        }

        .rating-option.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .week-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .day-card {
            border: 2px solid #e2e8f0;
            border-radius: 4px;
            padding: 1rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .day-card h4 {
            color: #4a5568;
            margin-bottom: 0.5rem;
        }

        .day-card.completed {
            background: #c6f6d5;
            border-color: #48bb78;
        }

        .day-card.missed {
            background: #fed7d7;
            border-color: #f56565;
        }

        .status-icon {
            font-size: 2rem;
            margin-top: 0.5rem;
        }

        .patient-list {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }

        .patient-card {
            border: 2px solid #e2e8f0;
            border-radius: 4px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .patient-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .patient-card h3 {
            color: #2d3748;
            margin-bottom: 0.5rem;
        }

        .patient-card p {
            color: #718096;
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #718096;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }

            .week-grid {
                grid-template-columns: 1fr;
            }

            .two-column {
                grid-template-columns: 1fr;
            }
        }

        /* Special styling for medication options */
        .medication-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .medication-option {
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .medication-option:hover {
            border-color: #667eea;
            background: #f7fafc;
        }

        .medication-option.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* Access code styling */
        .access-code-section {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 4px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .access-code-section h3 {
            color: #2d3748;
            margin-bottom: 1rem;
        }

        .access-code-section p {
            color: #718096;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>üè• Therapeutic Companion</h1>
            <p>Comprehensive Weekly Therapy Tracking System</p>
        </div>
    </header>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="showTab('enrollment')">Patient Enrollment</button>
            <button class="tab" onclick="showTab('checkin')">Daily Check-In</button>
            <button class="tab" onclick="showTab('progress')">Week Progress</button>
            <button class="tab" onclick="showTab('reports')">Generate Reports</button>
            <button class="tab" onclick="showTab('social-assessment')">Social Assessment</button>
        </div>

        <!-- Patient Enrollment Tab -->
        <div id="enrollment" class="content">
            <h2>Patient Enrollment</h2>
            <p>Register a new patient for weekly therapy tracking</p>

            <div class="access-code-section">
                <h3>Access Code Required</h3>
                <p>Please enter the access code provided by your administrator to enroll patients.</p>
                <div class="form-group">
                    <label for="accessCode">Access Code:</label>
                    <input type="password" id="accessCode" placeholder="Enter access code" value="therapy2024">
                </div>
            </div>

            <form id="enrollmentForm">
                <div class="two-column">
                    <div class="form-group">
                        <label for="patientId">Patient ID:</label>
                        <input type="text" id="patientId" required placeholder="e.g., PT001">
                    </div>

                    <div class="form-group">
                        <label for="patientName">Patient Name:</label>
                        <input type="text" id="patientName" required placeholder="Full name">
                    </div>
                </div>

                <div class="two-column">
                    <div class="form-group">
                        <label for="therapistName">Therapist Name:</label>
                        <input type="text" id="therapistName" required placeholder="Dr. Smith">
                    </div>

                    <div class="form-group">
                        <label for="therapistEmail">Therapist Email:</label>
                        <input type="email" id="therapistEmail" required placeholder="therapist@example.com">
                    </div>
                </div>

                <div class="form-group">
                    <label for="enrollmentNotes">Initial Notes:</label>
                    <textarea id="enrollmentNotes" placeholder="Any relevant initial information..."></textarea>
                </div>

                <button type="submit">Enroll Patient</button>
            </form>
        </div>

        <!-- Daily Check-In Tab -->
        <div id="checkin" class="content hidden">
            <h2>Daily Check-In</h2>
            <p>Record today's therapy tracking data</p>

            <form id="checkinForm">
                <div class="form-group">
                    <label for="checkinPatientId">Select Patient:</label>
                    <select id="checkinPatientId" required>
                        <option value="">-- Select Patient --</option>
                    </select>
                </div>

                <div class="two-column">
                    <div class="form-group">
                        <label for="checkinDate">Date:</label>
                        <input type="date" id="checkinDate" required>
                    </div>

                    <div class="form-group">
                        <label for="checkinTime">Time:</label>
                        <input type="time" id="checkinTime" required>
                    </div>
                </div>

                <!-- Emotional State -->
                <div class="form-group">
                    <label>Emotional State (1-5):</label>
                    <div class="rating-group">
                        <div class="rating-option" onclick="selectRating('emotional', 1)">
                            <div>1</div>
                            <small>Very Poor</small>
                        </div>
                        <div class="rating-option" onclick="selectRating('emotional', 2)">
                            <div>2</div>
                            <small>Poor</small>
                        </div>
                        <div class="rating-option" onclick="selectRating('emotional', 3)">
                            <div>3</div>
                            <small>Fair</small>
                        </div>
                        <div class="rating-option" onclick="selectRating('emotional', 4)">
                            <div>4</div>
                            <small>Good</small>
                        </div>
                        <div class="rating-option" onclick="selectRating('emotional', 5)">
                            <div>5</div>
                            <small>Excellent</small>
                        </div>
                    </div>
                    <input type="hidden" id="emotionalValue" required>
                </div>

                <div class="form-group">
                    <label for="emotionalNotes">Emotional State Notes:</label>
                    <textarea id="emotionalNotes" placeholder="Describe mood, triggers, or significant events..."></textarea>
                </div>

                <!-- Medication Adherence -->
                <div class="form-group">
                    <label>Medication Adherence:</label>
                    <div class="medication-options">
                        <div class="medication-option" onclick="selectMedication(0)">
                            <div>Not Applicable</div>
                        </div>
                        <div class="medication-option" onclick="selectMedication(1)">
                            <div>No Doses Taken</div>
                        </div>
                        <div class="medication-option" onclick="selectMedication(3)">
                            <div>Partial Doses</div>
                        </div>
                        <div class="medication-option" onclick="selectMedication(5)">
                            <div>All Doses Taken</div>
                        </div>
                    </div>
                    <input type="hidden" id="medicationValue" required>
                </div>

                <div class="form-group">
                    <label for="medicationNotes">Medication Notes:</label>
                    <textarea id="medicationNotes" placeholder="Side effects, missed doses, or concerns..."></textarea>
                </div>

                <!-- Physical Activity -->
                <div class="form-group">
                    <label>Physical Activity Level (1-5):</label>
                    <div class="rating-group">
                        <div class="rating-option" onclick="selectRating('activity', 1)">
                            <div>1</div>
                            <small>None</small>
                        </div>
                        <div class="rating-option" onclick="selectRating('activity', 2)">
                            <div>2</div>
                            <small>Minimal</small>
                        </div>
                        <div class="rating-option" onclick="selectRating('activity', 3)">
                            <div>3</div>
                            <small>Moderate</small>
                        </div>
                        <div class="rating-option" onclick="selectRating('activity', 4)">
                            <div>4</div>
                            <small>Good</small>
                        </div>
                        <div class="rating-option" onclick="selectRating('activity', 5)">
                            <div>5</div>
                            <small>Excellent</small>
                        </div>
                    </div>
                    <input type="hidden" id="activityValue" required>
                </div>

                <div class="form-group">
                    <label for="activityNotes">Activity Notes:</label>
                    <textarea id="activityNotes" placeholder="Type of activity, duration, or barriers..."></textarea>
                </div>

                <button type="submit">Save Check-In</button>
            </form>
        </div>

        <!-- Week Progress Tab -->
        <div id="progress" class="content hidden">
            <h2>Weekly Progress View</h2>
            <p>View check-in status for the current week</p>

            <div class="form-group">
                <label for="progressPatientId">Select Patient:</label>
                <select id="progressPatientId" onchange="loadWeekProgress()">
                    <option value="">-- Select Patient --</option>
                </select>
            </div>

            <div class="form-group">
                <label for="progressWeek">Select Week:</label>
                <input type="week" id="progressWeek" onchange="loadWeekProgress()">
            </div>

            <div id="weekProgressDisplay" class="week-grid"></div>
        </div>

        <!-- Generate Reports Tab -->
        <div id="reports" class="content hidden">
            <h2>Generate Weekly Reports</h2>
            <p>Create and download Excel reports for completed weeks</p>

            <div class="form-group">
                <label for="reportPatientId">Select Patient:</label>
                <select id="reportPatientId">
                    <option value="">-- Select Patient --</option>
                </select>
            </div>

            <div class="form-group">
                <label for="reportWeek">Select Week:</label>
                <input type="week" id="reportWeek">
            </div>

            <div style="display: flex; gap: 1rem;">
                <button onclick="generateReport()">üìä Generate Excel Report</button>
                <button onclick="emailReport()">üìß Email Report to Therapist</button>
            </div>

            <div id="reportStatus" style="margin-top: 2rem;"></div>
        </div>

        <!-- Social Worker Assessment Tab -->
        <div id="social-assessment" class="content hidden">
            <h2>Social Worker Assessment</h2>
            <p>Comprehensive patient assessment with country-specific recommendations</p>

            <form id="assessmentForm">
                <div class="two-column">
                    <div class="form-group">
                        <label for="assessName">Patient Name:</label>
                        <input type="text" id="assessName" required placeholder="Full name or initials">
                    </div>

                    <div class="form-group">
                        <label for="assessAge">Age:</label>
                        <input type="number" id="assessAge" required min="0" max="120" placeholder="Age in years">
                    </div>
                </div>

                <div class="two-column">
                    <div class="form-group">
                        <label for="assessCountry">Country:</label>
                        <select id="assessCountry" required>
                            <option value="">-- Select Country --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="assessCity">City:</label>
                        <input type="text" id="assessCity" required placeholder="City name">
                    </div>
                </div>

                <div class="two-column">
                    <div class="form-group">
                        <label for="assessGender">Gender:</label>
                        <select id="assessGender" required>
                            <option value="">-- Select --</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Non-binary">Non-binary</option>
                            <option value="Prefer not to say">Prefer not to say</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="assessEmployment">Employment Status:</label>
                        <select id="assessEmployment" required>
                            <option value="">-- Select --</option>
                            <option value="Full-time employed">Full-time employed</option>
                            <option value="Part-time employed">Part-time employed</option>
                            <option value="Unemployed - actively seeking">Unemployed - actively seeking</option>
                            <option value="Unemployed - not seeking">Unemployed - not seeking</option>
                            <option value="Student">Student</option>
                            <option value="Retired">Retired</option>
                            <option value="Unable to work">Unable to work</option>
                        </select>
                    </div>
                </div>

                <div class="two-column">
                    <div class="form-group">
                        <label for="assessFinancial">Financial Status:</label>
                        <select id="assessFinancial" required>
                            <option value="">-- Select --</option>
                            <option value="low_income">Low income - difficulty meeting basic needs</option>
                            <option value="moderate_income">Moderate income - meets basic needs with constraints</option>
                            <option value="stable_income">Stable income - comfortable with discretionary spending</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="assessExercise">Exercise Level:</label>
                        <select id="assessExercise" required>
                            <option value="">-- Select --</option>
                            <option value="Very active">Very active (5+ times per week)</option>
                            <option value="Moderately active">Moderately active (3-4 times per week)</option>
                            <option value="Lightly active">Lightly active (1-2 times per week)</option>
                            <option value="Sedentary">Sedentary (little to no exercise)</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="assessMental">Mental State:</label>
                    <select id="assessMental" required>
                        <option value="">-- Select --</option>
                        <option value="Excellent">Excellent - feeling very positive and energetic</option>
                        <option value="Good">Good - generally positive with minor concerns</option>
                        <option value="Fair">Fair - some challenges but managing</option>
                        <option value="Poor">Poor - struggling with daily activities</option>
                        <option value="Critical">Critical - severe distress or crisis</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="assessNotes">Additional Notes:</label>
                    <textarea id="assessNotes" placeholder="Any additional concerns or relevant information..."></textarea>
                </div>

                <button type="submit">Run Assessment</button>
            </form>

            <div id="assessmentResults" style="margin-top: 2rem;"></div>
        </div>
    </div>

    <script>
        // Global variables
        let currentTab = 'enrollment';
        let patients = [];
        let selectedRatings = {};

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Set default dates to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('checkinDate').value = today;

            const now = new Date();
            const time = now.toTimeString().slice(0,5);
            document.getElementById('checkinTime').value = time;

            // Set current week
            const year = now.getFullYear();
            const week = getWeekNumber(now);
            document.getElementById('progressWeek').value = `${year}-W${week.toString().padStart(2, '0')}`;
            document.getElementById('reportWeek').value = `${year}-W${week.toString().padStart(2, '0')}`;

            // Load initial data
            loadPatients();
            loadCountries();

            // Set up form handlers
            document.getElementById('enrollmentForm').addEventListener('submit', enrollPatient);
            document.getElementById('checkinForm').addEventListener('submit', saveCheckin);
            document.getElementById('assessmentForm').addEventListener('submit', runAssessment);
        });

        // Tab switching
        function showTab(tabName) {
            // Hide all content
            document.querySelectorAll('.content').forEach(content => {
                content.classList.add('hidden');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected content
            document.getElementById(tabName).classList.remove('hidden');

            // Mark tab as active
            event.target.classList.add('active');

            currentTab = tabName;

            // Refresh data if needed
            if (tabName === 'checkin' || tabName === 'progress' || tabName === 'reports') {
                loadPatients();
            }
        }

        // Get week number
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        }

        // Rating selection
        function selectRating(type, value) {
            // Remove previous selection
            document.querySelectorAll(`.rating-option`).forEach(option => {
                if (option.textContent.includes(['Very Poor', 'Poor', 'Fair', 'Good', 'Excellent', 'None', 'Minimal', 'Moderate'][value-1] ||
                    option.textContent.includes(value.toString()))) {
                    if (type === 'emotional' && option.parentElement.previousElementSibling?.textContent.includes('Emotional') ||
                        type === 'activity' && option.parentElement.previousElementSibling?.textContent.includes('Physical')) {
                        option.classList.remove('selected');
                    }
                }
            });

            // Add selection to clicked option
            event.target.closest('.rating-option').classList.add('selected');

            // Store the value
            if (type === 'emotional') {
                document.getElementById('emotionalValue').value = value;
            } else if (type === 'activity') {
                document.getElementById('activityValue').value = value;
            }

            selectedRatings[type] = value;
        }

        // Medication selection
        function selectMedication(value) {
            // Remove previous selection
            document.querySelectorAll('.medication-option').forEach(option => {
                option.classList.remove('selected');
            });

            // Add selection
            event.target.closest('.medication-option').classList.add('selected');
            document.getElementById('medicationValue').value = value;
            selectedRatings['medication'] = value;
        }

        // Load patients
        async function loadPatients() {
            try {
                const response = await fetch('/api/therapy/get-all-patients');
                const data = await response.json();

                if (data.success) {
                    patients = data.patients;
                    updatePatientSelects();
                }
            } catch (error) {
                console.error('Error loading patients:', error);
            }
        }

        // Update patient select elements
        function updatePatientSelects() {
            const selects = ['checkinPatientId', 'progressPatientId', 'reportPatientId'];

            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">-- Select Patient --</option>';

                    patients.forEach(patient => {
                        const option = document.createElement('option');
                        option.value = patient.patientId;
                        option.textContent = `${patient.name} (${patient.patientId})`;
                        select.appendChild(option);
                    });

                    // Restore previous selection if it still exists
                    if (currentValue && patients.find(p => p.patientId === currentValue)) {
                        select.value = currentValue;
                    }
                }
            });
        }

        // Enroll patient
        async function enrollPatient(e) {
            e.preventDefault();

            const accessCode = document.getElementById('accessCode').value;
            const patientData = {
                patientId: document.getElementById('patientId').value,
                accessCode: accessCode,
                patientData: {
                    name: document.getElementById('patientName').value,
                    therapistName: document.getElementById('therapistName').value,
                    therapistEmail: document.getElementById('therapistEmail').value,
                    notes: document.getElementById('enrollmentNotes').value
                }
            };

            try {
                const response = await fetch('/api/therapy/save-patient', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(patientData)
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('success', `Patient ${patientData.patientData.name} enrolled successfully!`);
                    document.getElementById('enrollmentForm').reset();
                    loadPatients();
                } else {
                    showMessage('error', result.error || 'Failed to enroll patient');
                }
            } catch (error) {
                showMessage('error', 'Error enrolling patient: ' + error.message);
            }
        }

        // Save check-in
        async function saveCheckin(e) {
            e.preventDefault();

            const checkinData = {
                patientId: document.getElementById('checkinPatientId').value,
                checkinData: {
                    date: document.getElementById('checkinDate').value,
                    time: document.getElementById('checkinTime').value,
                    emotional: {
                        value: parseInt(document.getElementById('emotionalValue').value),
                        notes: document.getElementById('emotionalNotes').value
                    },
                    medication: {
                        value: parseInt(document.getElementById('medicationValue').value),
                        notes: document.getElementById('medicationNotes').value
                    },
                    activity: {
                        value: parseInt(document.getElementById('activityValue').value),
                        notes: document.getElementById('activityNotes').value
                    }
                }
            };

            try {
                const response = await fetch('/api/therapy/save-checkin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(checkinData)
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('success', 'Check-in saved successfully!');
                    document.getElementById('checkinForm').reset();

                    // Reset visual selections
                    document.querySelectorAll('.rating-option, .medication-option').forEach(option => {
                        option.classList.remove('selected');
                    });

                    // Reset to today's date and time
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('checkinDate').value = today;
                    const time = new Date().toTimeString().slice(0,5);
                    document.getElementById('checkinTime').value = time;
                } else {
                    showMessage('error', result.error || 'Failed to save check-in');
                }
            } catch (error) {
                showMessage('error', 'Error saving check-in: ' + error.message);
            }
        }

        // Load week progress
        async function loadWeekProgress() {
            const patientId = document.getElementById('progressPatientId').value;
            const week = document.getElementById('progressWeek').value;

            if (!patientId || !week) return;

            const display = document.getElementById('weekProgressDisplay');
            display.innerHTML = '<div class="loading">Loading week data...</div>';

            try {
                const response = await fetch(`/api/therapy/get-week-data/${patientId}/${week}`);
                const data = await response.json();

                if (data.success) {
                    displayWeekProgress(data.weekData, week);
                } else {
                    display.innerHTML = '<div class="error">Failed to load week data</div>';
                }
            } catch (error) {
                display.innerHTML = '<div class="error">Error loading week data</div>';
            }
        }

        // Display week progress
        function displayWeekProgress(weekData, weekString) {
            const display = document.getElementById('weekProgressDisplay');
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

            // Parse week to get dates
            const [year, weekNum] = weekString.split('-W');
            const jan4 = new Date(year, 0, 4);
            const weekStart = new Date(jan4);
            weekStart.setDate(jan4.getDate() - jan4.getDay() + 1 + (weekNum - 1) * 7);

            let html = '';

            for (let i = 0; i < 7; i++) {
                const date = new Date(weekStart);
                date.setDate(weekStart.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                const dayData = weekData[dateStr];

                const isCompleted = dayData !== undefined;
                const statusClass = isCompleted ? 'completed' : 'missed';
                const statusIcon = isCompleted ? '‚úÖ' : '‚ùå';

                html += `
                    <div class="day-card ${statusClass}">
                        <h4>${days[i]}</h4>
                        <p>${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</p>
                        <div class="status-icon">${statusIcon}</div>
                        ${isCompleted ? `
                            <div style="margin-top: 0.5rem; font-size: 0.9rem;">
                                <div>Emotional: ${dayData.emotional.value}/5</div>
                                <div>Medication: ${getMedicationText(dayData.medication.value)}</div>
                                <div>Activity: ${dayData.activity.value}/5</div>
                            </div>
                        ` : '<p style="margin-top: 0.5rem; font-size: 0.9rem;">No check-in</p>'}
                    </div>
                `;
            }

            display.innerHTML = html;
        }

        // Get medication text
        function getMedicationText(value) {
            const texts = {
                0: 'N/A',
                1: 'None',
                3: 'Partial',
                5: 'Full'
            };
            return texts[value] || value;
        }

        // Generate report
        async function generateReport() {
            const patientId = document.getElementById('reportPatientId').value;
            const week = document.getElementById('reportWeek').value;

            if (!patientId || !week) {
                showMessage('error', 'Please select a patient and week');
                return;
            }

            const statusDiv = document.getElementById('reportStatus');
            statusDiv.innerHTML = '<div class="info">Generating report...</div>';

            try {
                const response = await fetch(`/api/therapy/generate-excel-report/${patientId}/${week}`);

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `therapy_report_${patientId}_${week}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    statusDiv.innerHTML = '<div class="success">Report generated and downloaded successfully!</div>';
                } else {
                    const error = await response.json();
                    statusDiv.innerHTML = `<div class="error">Failed to generate report: ${error.error}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">Error generating report: ${error.message}</div>`;
            }
        }

        // Email report
        async function emailReport() {
            const patientId = document.getElementById('reportPatientId').value;
            const week = document.getElementById('reportWeek').value;

            if (!patientId || !week) {
                showMessage('error', 'Please select a patient and week');
                return;
            }

            const statusDiv = document.getElementById('reportStatus');
            statusDiv.innerHTML = '<div class="info">Sending email...</div>';

            try {
                const response = await fetch('/api/therapy/email-report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ patientId, week })
                });

                const result = await response.json();

                if (result.success) {
                    statusDiv.innerHTML = `<div class="success">Report sent to ${result.recipient}!</div>`;
                } else {
                    statusDiv.innerHTML = `<div class="error">${result.error || result.note || 'Failed to send email'}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">Error sending email: ${error.message}</div>`;
            }
        }

        // Load countries for assessment
        async function loadCountries() {
            try {
                const response = await fetch('/api/countries');
                const data = await response.json();

                if (data.success) {
                    const select = document.getElementById('assessCountry');
                    data.countries.forEach(country => {
                        const option = document.createElement('option');
                        option.value = country.code;
                        option.textContent = country.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading countries:', error);
            }
        }

        // Run assessment
        async function runAssessment(e) {
            e.preventDefault();

            const assessmentData = {
                name: document.getElementById('assessName').value,
                age: document.getElementById('assessAge').value,
                country: document.getElementById('assessCountry').value,
                city: document.getElementById('assessCity').value,
                gender: document.getElementById('assessGender').value,
                employment: document.getElementById('assessEmployment').value,
                financial: document.getElementById('assessFinancial').value,
                exercise: document.getElementById('assessExercise').value,
                mental: document.getElementById('assessMental').value,
                notes: document.getElementById('assessNotes').value
            };

            const resultsDiv = document.getElementById('assessmentResults');
            resultsDiv.innerHTML = '<div class="loading">Running assessment...</div>';

            try {
                const response = await fetch('/api/assess', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(assessmentData)
                });

                const result = await response.json();

                if (result.success) {
                    displayAssessmentResults(result);
                } else {
                    resultsDiv.innerHTML = `<div class="error">Assessment failed: ${result.error}</div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">Error running assessment: ${error.message}</div>`;
            }
        }

        // Display assessment results
        function displayAssessmentResults(result) {
            const resultsDiv = document.getElementById('assessmentResults');

            let html = '<div class="assessment-results">';

            // Risk level
            const riskColors = {
                'critical': '#f56565',
                'high': '#ed8936',
                'moderate': '#ecc94b',
                'low': '#48bb78'
            };

            html += `
                <div style="background: ${riskColors[result.risk_indicators.level]}; color: white; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">
                    <h3>Risk Level: ${result.risk_indicators.level.toUpperCase()}</h3>
                    ${result.risk_indicators.requires_immediate_attention ?
                        '<p>‚ö†Ô∏è Requires immediate attention</p>' : ''}
                </div>
            `;

            // Country context
            html += `
                <div style="background: #f7fafc; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">
                    <h3>Country Context: ${result.country_context.name}</h3>
                    <p>Mental health prevalence: ${result.country_context.mental_health_prevalence}%</p>
                    <p>Healthcare system: ${result.country_context.healthcare_system}</p>
                    <p>Crisis resources: ${result.country_context.crisis_resources.join(', ')}</p>
                </div>
            `;

            // Recommendations sections
            const sections = [
                'country_health_needs',
                'country_safety_needs',
                'country_evidence_recommendations',
                'general_recommendations'
            ];

            sections.forEach(section => {
                const data = result.assessments[section];
                if (data && Object.keys(data).length > 0) {
                    html += `<h3>${section.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</h3>`;

                    for (const [category, items] of Object.entries(data)) {
                        if (items && items.length > 0) {
                            html += `<h4>${category.replace(/_/g, ' ')}</h4><ul>`;
                            items.forEach(item => {
                                html += `<li>${item}</li>`;
                            });
                            html += '</ul>';
                        }
                    }
                }
            });

            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        // Show message
        function showMessage(type, message) {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = message;

            const container = document.querySelector('.content:not(.hidden)');
            container.insertBefore(div, container.firstChild);

            setTimeout(() => {
                div.remove();
            }, 5000);
        }
    </script>
</body>
</html>